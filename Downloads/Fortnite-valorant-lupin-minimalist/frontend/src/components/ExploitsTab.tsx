import { useState, useEffect } from 'react'
import './ExploitsTab.css'

interface Exploit {
  id: string
  cve_id: string
  title: string
  description: string
  exploit_content: string
  exploit_type: string
  severity: string
  source: string | null
  source_type: string | null
  target_models: string[] | null
  mitigation: string | null
  status: string
  discovered_date: string | null
  created_at: string
}

interface ExploitFilters {
  severity: string
  exploitType: string
  status: string
  sourceType: string
  search: string
  startDate: string
  endDate: string
}

const createDefaultFilters = (): ExploitFilters => ({
  severity: '',
  exploitType: '',
  status: '',
  sourceType: '',
  search: '',
  startDate: '',
  endDate: ''
})

// interface TestRun {
//   id: string
//   run_name: string
//   exploit_id: string
//   target_model: string
//   success: boolean
//   blocked: boolean
//   timestamp: string
// }

interface ExploitStats {
  total_exploits: number
  active_exploits: number
  by_severity: Record<string, number>
  by_type: Record<string, number>
}

export default function ExploitsTab() {
  const [activeView, setActiveView] = useState<'list' | 'search'>('list')
  const [exploits, setExploits] = useState<Exploit[]>([])
  const [stats, setStats] = useState<ExploitStats | null>(null)
  const [selectedExploit, setSelectedExploit] = useState<Exploit | null>(null)
  const [loading, setLoading] = useState(false)
  const [filters, setFilters] = useState<ExploitFilters>(createDefaultFilters())

  // Search state
  const [searchQuery, setSearchQuery] = useState('')
  const [searchResults, setSearchResults] = useState<any[]>([])
  const [discovering, setDiscovering] = useState(false)
  const [discoveryResults, setDiscoveryResults] = useState<any>(null)

  // Add/Edit exploit state
  const [showAddForm, setShowAddForm] = useState(false)
  const [formData, setFormData] = useState({
    cve_id: '',
    title: '',
    description: '',
    exploit_content: '',
    exploit_type: 'jailbreak',
    severity: 'medium',
    source: '',
    source_type: 'manual',
    target_models: '',
    mitigation: '',
    status: 'active',
    discovered_date: ''
  })

  const formatDiscoveredDate = (value?: string | null) => {
    if (!value) {
      return 'Unknown'
    }
    const parsed = new Date(value)
    if (Number.isNaN(parsed.getTime())) {
      return 'Unknown'
    }
    return parsed.toLocaleDateString()
  }

  const toISODate = (value: string, endOfDay = false) => {
    if (!value) {
      return null
    }
    const parsed = new Date(value)
    if (Number.isNaN(parsed.getTime())) {
      return null
    }
    if (endOfDay) {
      parsed.setHours(23, 59, 59, 999)
    }
    return parsed.toISOString()
  }

  const handleFilterChange = (field: keyof ExploitFilters, value: string) => {
    setFilters((prev) => ({
      ...prev,
      [field]: value
    }))
  }

  const applyFilters = () => {
    if (filters.startDate && filters.endDate && filters.startDate > filters.endDate) {
      alert('Discovery start date cannot be later than the end date.')
      return
    }
    fetchExploits()
  }

  const resetFilters = () => {
    const baseFilters = createDefaultFilters()
    setFilters(baseFilters)
    fetchExploits(baseFilters)
  }

  useEffect(() => {
    fetchExploits()
    fetchStats()
  }, [])

  const fetchExploits = async (overrideFilters?: ExploitFilters) => {
    setLoading(true)
    const activeFilters = overrideFilters || filters
    try {
      const params = new URLSearchParams({ limit: '1000' })

      if (activeFilters.status && activeFilters.status !== 'all') {
        params.append('status', activeFilters.status)
      }
      if (activeFilters.exploitType) {
        params.append('exploit_type', activeFilters.exploitType)
      }
      if (activeFilters.severity) {
        params.append('severity', activeFilters.severity)
      }
      if (activeFilters.sourceType) {
        params.append('source_type', activeFilters.sourceType)
      }
      if (activeFilters.search && activeFilters.search.trim()) {
        params.append('search', activeFilters.search.trim())
      }

      const startISO = toISODate(activeFilters.startDate)
      const endISO = toISODate(activeFilters.endDate, true)

      if (startISO) {
        params.append('discovered_after', startISO)
      }
      if (endISO) {
        params.append('discovered_before', endISO)
      }

      const response = await fetch(`http://localhost:8000/api/exploits/?${params.toString()}`)
      const data = await response.json()
      setExploits(data)
    } catch (error) {
      console.error('Failed to fetch exploits:', error)
    }
    setLoading(false)
  }

  const fetchStats = async () => {
    try {
      const response = await fetch('http://localhost:8000/api/exploits/stats/summary')
      const data = await response.json()
      setStats(data)
    } catch (error) {
      console.error('Failed to fetch stats:', error)
    }
  }

  const handleDiscover = async (autoAdd: boolean = false) => {
    setDiscovering(true)
    setDiscoveryResults(null)

    try {
      const url = new URL('http://localhost:8000/api/exploits/discover')
      if (searchQuery) {
        url.searchParams.append('query', searchQuery)
      }
      url.searchParams.append('auto_add', autoAdd.toString())

      const response = await fetch(url.toString(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.detail || 'Discovery failed')
      }

      const data = await response.json()
      setDiscoveryResults(data)

      if (autoAdd) {
        // Refresh exploits list if we auto-added
        await fetchExploits()
        await fetchStats()
        alert(`Success! Added ${data.exploits_added} new exploits to database (${data.duplicates_skipped} duplicates skipped)`)
      } else {
        setSearchResults(data.results || [])
      }
    } catch (error) {
      console.error('Discovery failed:', error)
      alert('Discovery failed: ' + error)
    }
    setDiscovering(false)
  }

  const openAddForm = async () => {
    console.log('openAddForm called')
    // Generate new CVE ID
    try {
      const response = await fetch('http://localhost:8000/api/exploits/generate-cve-id', {
        method: 'POST'
      })
      const data = await response.json()
      console.log('Generated CVE ID:', data.cve_id)
      setFormData({
        cve_id: data.cve_id,
        title: '',
        description: '',
        exploit_content: '',
        exploit_type: 'jailbreak',
        severity: 'medium',
        source: '',
        source_type: 'manual',
        target_models: '',
        mitigation: '',
        status: 'active',
        discovered_date: ''
      })
      console.log('Setting showAddForm to true')
      setShowAddForm(true)
    } catch (error) {
      console.error('Failed to generate CVE ID:', error)
      alert('Failed to generate CVE ID: ' + error)
    }
  }

  const createExploit = async () => {
    try {
      // Parse target_models from comma-separated string
      const target_models = formData.target_models
        ? formData.target_models.split(',').map(m => m.trim()).filter(m => m)
        : []

      const payload = {
        ...formData,
        target_models,
        discovered_date: toISODate(formData.discovered_date)
      }

      const response = await fetch('http://localhost:8000/api/exploits/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })

      if (!response.ok) {
        const error = await response.json()
        alert(`Failed to create exploit: ${error.detail || 'Unknown error'}`)
        return
      }

      // Success
      setShowAddForm(false)
      fetchExploits()
      fetchStats()
    } catch (error) {
      console.error('Failed to create exploit:', error)
      alert('Failed to create exploit: ' + error)
    }
  }

  const createExploitFromSearch = async (result: any) => {
    try {
      const response = await fetch('http://localhost:8000/api/exploits/generate-cve-id', {
        method: 'POST'
      })
      const data = await response.json()

      let discoveredDateInput = ''
      const rawDiscoveryDate = result.discovered_date || result.discoveredDate || result.date || result.publishedAt || result.published_at
      if (rawDiscoveryDate) {
        const parsed = new Date(rawDiscoveryDate)
        if (!Number.isNaN(parsed.getTime())) {
          discoveredDateInput = parsed.toISOString().slice(0, 10)
        }
      }

      // Pre-fill form with search result data
      setFormData({
        cve_id: data.cve_id,
        title: result.title || 'Imported Exploit',
        description: result.description || '',
        exploit_content: result.exploit_content || result.content || '',
        exploit_type: result.exploit_type || 'prompt_injection',
        severity: result.severity || 'medium',
        source: result.source || 'Hugging Face Search',
        source_type: 'huggingface',
        target_models: Array.isArray(result.target_models) ? result.target_models.join(', ') : '',
        mitigation: result.mitigation || '',
        status: 'active',
        discovered_date: discoveredDateInput
      })
      setShowAddForm(true)
    } catch (error) {
      console.error('Failed to prepare import:', error)
    }
  }

  const deleteExploit = async (exploitId: string) => {
    if (!confirm('Are you sure you want to delete this exploit? This action cannot be undone.')) {
      return
    }

    try {
      const response = await fetch(`http://localhost:8000/api/exploits/${exploitId}`, {
        method: 'DELETE'
      })

      if (!response.ok) {
        const error = await response.json()
        alert(`Failed to delete exploit: ${error.detail || 'Unknown error'}`)
        return
      }

      // Success - close modal and refresh list
      setSelectedExploit(null)
      await fetchExploits()
      await fetchStats()
      alert('Exploit deleted successfully')
    } catch (error) {
      console.error('Failed to delete exploit:', error)
      alert('Failed to delete exploit: ' + error)
    }
  }

  const getSeverityColor = (severity: string) => {
    switch (severity?.toLowerCase()) {
      case 'critical': return '#dc3545'
      case 'high': return '#fd7e14'
      case 'medium': return '#ffc107'
      case 'low': return '#28a745'
      default: return '#6c757d'
    }
  }

  // Debug showAddForm state
  useEffect(() => {
    console.log('showAddForm state changed:', showAddForm)
  }, [showAddForm])

  return (
    <div className="exploits-tab">
      <div className="exploit-header">
        <div className="exploit-nav">
          <button
            className={activeView === 'list' ? 'active' : ''}
            onClick={() => setActiveView('list')}
          >
            EXPLOITS DATABASE
          </button>
          <button
            className={activeView === 'search' ? 'active' : ''}
            onClick={() => setActiveView('search')}
          >
            SEARCH & DISCOVER
          </button>
        </div>

        {stats && (
          <div className="exploit-stats">
            <div className="stat-item">
              <span className="stat-label">Total</span>
              <span className="stat-value">{stats.total_exploits}</span>
            </div>
            <div className="stat-item">
              <span className="stat-label">Active</span>
              <span className="stat-value">{stats.active_exploits}</span>
            </div>
            <div className="stat-item">
              <span className="stat-label">Critical</span>
              <span className="stat-value" style={{ color: '#dc3545' }}>
                {stats.by_severity?.critical || 0}
              </span>
            </div>
          </div>
        )}
      </div>

      {activeView === 'list' && (
        <div className="exploits-list-view">
          <div className="list-controls">
            <button className="btn-add" onClick={openAddForm}>
              + ADD EXPLOIT
            </button>
            <button className="btn-refresh" onClick={() => fetchExploits()}>
              REFRESH
            </button>
          </div>

          <div className="filter-panel">
            <div className="filter-row">
              <div className="filter-group wide">
                <label>Search</label>
                <input
                  type="text"
                  value={filters.search}
                  onChange={(e) => handleFilterChange('search', e.target.value)}
                  placeholder="Search CVE ID, title, or description"
                />
              </div>
            </div>

            <div className="filter-row">
              <div className="filter-group">
                <label>Severity</label>
                <select
                  value={filters.severity}
                  onChange={(e) => handleFilterChange('severity', e.target.value)}
                >
                  <option value="">All severities</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>

              <div className="filter-group">
                <label>Exploit Type</label>
                <select
                  value={filters.exploitType}
                  onChange={(e) => handleFilterChange('exploitType', e.target.value)}
                >
                  <option value="">All types</option>
                  <option value="jailbreak">Jailbreak</option>
                  <option value="prompt_injection">Prompt Injection</option>
                  <option value="data_extraction">Data Extraction</option>
                  <option value="social_engineering">Social Engineering</option>
                  <option value="encoding_bypass">Encoding Bypass</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div className="filter-group">
                <label>Source Type</label>
                <select
                  value={filters.sourceType}
                  onChange={(e) => handleFilterChange('sourceType', e.target.value)}
                >
                  <option value="">All sources</option>
                  <option value="manual">Manual</option>
                  <option value="huggingface">Hugging Face</option>
                  <option value="github">GitHub</option>
                  <option value="bug_bounty">Bug Bounty</option>
                  <option value="perplexity">Perplexity</option>
                  <option value="research">Research</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div className="filter-group">
                <label>Status</label>
                <select
                  value={filters.status}
                  onChange={(e) => handleFilterChange('status', e.target.value)}
                >
                  <option value="">Active & Patched</option>
                  <option value="active">Active</option>
                  <option value="patched">Patched</option>
                  <option value="archived">Archived</option>
                </select>
              </div>
            </div>

            <div className="filter-row">
              <div className="filter-group">
                <label>Discovered After</label>
                <input
                  type="date"
                  value={filters.startDate}
                  onChange={(e) => handleFilterChange('startDate', e.target.value)}
                />
              </div>
              <div className="filter-group">
                <label>Discovered Before</label>
                <input
                  type="date"
                  value={filters.endDate}
                  onChange={(e) => handleFilterChange('endDate', e.target.value)}
                />
              </div>
            </div>

            <div className="filter-actions">
              <button className="btn-clear" type="button" onClick={resetFilters}>
                Clear Filters
              </button>
              <button className="btn-apply" type="button" onClick={applyFilters}>
                Apply Filters
              </button>
            </div>
          </div>

          {loading ? (
            <div className="loading">Loading exploits...</div>
          ) : (
            <div className="exploits-grid">
              {exploits.map((exploit) => (
                <div
                  key={exploit.id}
                  className="exploit-card"
                  onClick={() => setSelectedExploit(exploit)}
                >
                  <div className="exploit-card-header">
                    <span className="cve-id">{exploit.cve_id}</span>
                    <span
                      className="severity-badge"
                      style={{ background: getSeverityColor(exploit.severity) }}
                    >
                      {exploit.severity?.toUpperCase()}
                    </span>
                  </div>
                  <h3 className="exploit-title">{exploit.title}</h3>
                  <p className="exploit-description">{exploit.description}</p>
                  <div className="exploit-meta">
                    <span className="meta-item">Type: {exploit.exploit_type || 'unknown'}</span>
                    <span className="meta-item">Source: {exploit.source_type || 'unknown'}</span>
                    <span className="meta-item">Discovered: {formatDiscoveredDate(exploit.discovered_date)}</span>
                  </div>
                </div>
              ))}
            </div>
          )}

          {exploits.length === 0 && !loading && (
            <div className="empty-state">
              <p>No exploits in database. Start by searching or adding manually.</p>
            </div>
          )}
        </div>
      )}

      {activeView === 'search' && (
        <div className="search-view">
          <div className="search-controls">
            <div className="input-group">
              <label>Search Query (optional):</label>
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Leave empty to search all default queries, or enter custom query"
              />
            </div>
            <div className="button-group">
              <button
                className="btn-search"
                onClick={() => handleDiscover(false)}
                disabled={discovering}
              >
                {discovering ? 'SEARCHING...' : 'PREVIEW RESULTS'}
              </button>
              <button
                className="btn-discover"
                onClick={() => handleDiscover(true)}
                disabled={discovering}
              >
                {discovering ? 'DISCOVERING...' : 'DISCOVER & ADD TO DATABASE'}
              </button>
            </div>
            {discoveryResults && discoveryResults.mode === 'auto_add' && (
              <div className="discovery-summary">
                <p>
                  Processed {discoveryResults.queries_processed} queries •
                  Found {discoveryResults.exploits_found} exploits •
                  Added {discoveryResults.exploits_added} new •
                  Skipped {discoveryResults.duplicates_skipped} duplicates
                </p>
              </div>
            )}
          </div>

          <div className="search-results">
            {searchResults.length > 0 ? (
              searchResults.map((result, idx) => (
                <div key={idx} className="search-result-card">
                  <h4>{result.title || 'Search Result'}</h4>
                  <p>{result.description || result.content || JSON.stringify(result)}</p>
                  {result.citations && result.citations.length > 0 && (
                    <div className="citations">
                      <strong>Sources:</strong>
                      {result.citations.map((cite: string, i: number) => (
                        <a key={i} href={cite} target="_blank" rel="noopener noreferrer">
                          [{i + 1}]
                        </a>
                      ))}
                    </div>
                  )}
                  <button
                    className="btn-import"
                    onClick={() => createExploitFromSearch(result)}
                  >
                    Import as Exploit
                  </button>
                </div>
              ))
            ) : (
              <div className="empty-state">
                <p>Click "DISCOVER & ADD TO DATABASE" to automatically search for and add new PIEs to your database.</p>
                <p>Or click "PREVIEW RESULTS" to see what would be found before adding.</p>
              </div>
            )}
          </div>
        </div>
      )}

      {showAddForm && (
        <div className="exploit-modal" onClick={() => setShowAddForm(false)}>
          <div className="modal-content form-modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Add New Exploit</h2>
              <button className="close-btn" onClick={() => setShowAddForm(false)}>×</button>
            </div>
            <div className="modal-body">
              <div className="form-group">
                <label>CVE ID:</label>
                <input
                  type="text"
                  value={formData.cve_id}
                  onChange={(e) => setFormData({ ...formData, cve_id: e.target.value })}
                  placeholder="PIE-2025-001"
                />
              </div>

              <div className="form-group">
                <label>Title: *</label>
                <input
                  type="text"
                  value={formData.title}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  placeholder="Short descriptive title"
                  required
                />
              </div>

              <div className="form-group">
                <label>Description: *</label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  placeholder="Detailed description of the exploit and how it works"
                  rows={3}
                  required
                />
              </div>

              <div className="form-group">
                <label>Full Exploit Prompt: *</label>
                <textarea
                  value={formData.exploit_content}
                  onChange={(e) => setFormData({ ...formData, exploit_content: e.target.value })}
                  placeholder="The complete jailbreak prompt that can be tested against models"
                  rows={6}
                  required
                />
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Type:</label>
                  <select
                    value={formData.exploit_type}
                    onChange={(e) => setFormData({ ...formData, exploit_type: e.target.value })}
                  >
                    <option value="jailbreak">Jailbreak</option>
                    <option value="prompt_injection">Prompt Injection</option>
                    <option value="data_extraction">Data Extraction</option>
                    <option value="social_engineering">Social Engineering</option>
                    <option value="encoding_bypass">Encoding Bypass</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div className="form-group">
                  <label>Severity:</label>
                  <select
                    value={formData.severity}
                    onChange={(e) => setFormData({ ...formData, severity: e.target.value })}
                  >
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label>Target Models (comma-separated):</label>
                <input
                  type="text"
                  value={formData.target_models}
                  onChange={(e) => setFormData({ ...formData, target_models: e.target.value })}
                  placeholder="gpt-4, claude-3, gemini-pro"
                />
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Source:</label>
                  <input
                    type="text"
                    value={formData.source}
                    onChange={(e) => setFormData({ ...formData, source: e.target.value })}
                    placeholder="Where this exploit was discovered"
                  />
                </div>
                <div className="form-group">
                  <label>Source Type:</label>
                  <select
                    value={formData.source_type}
                    onChange={(e) => setFormData({ ...formData, source_type: e.target.value })}
                  >
                    <option value="manual">Manual</option>
                    <option value="huggingface">Hugging Face</option>
                    <option value="github">GitHub</option>
                    <option value="bug_bounty">Bug Bounty</option>
                    <option value="perplexity">Perplexity</option>
                    <option value="research">Research</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Date Discovered:</label>
                  <input
                    type="date"
                    value={formData.discovered_date}
                    onChange={(e) => setFormData({ ...formData, discovered_date: e.target.value })}
                  />
                </div>
                <div className="form-group">
                  <label>Status:</label>
                  <select
                    value={formData.status}
                    onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                  >
                    <option value="active">Active</option>
                    <option value="patched">Patched</option>
                    <option value="archived">Archived</option>
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label>Mitigation Strategies:</label>
                <textarea
                  value={formData.mitigation}
                  onChange={(e) => setFormData({ ...formData, mitigation: e.target.value })}
                  placeholder="Recommended mitigations or patches"
                  rows={3}
                />
              </div>

              <div className="form-actions">
                <button className="btn-cancel" onClick={() => setShowAddForm(false)}>
                  Cancel
                </button>
                <button className="btn-submit" onClick={createExploit}>
                  Create Exploit
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {selectedExploit && (
        <div className="exploit-modal" onClick={() => setSelectedExploit(null)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{selectedExploit.cve_id}: {selectedExploit.title}</h2>
              <button className="close-btn" onClick={() => setSelectedExploit(null)}>×</button>
            </div>
            <div className="modal-body">
              <div className="field">
                <label>Severity:</label>
                <span
                  className="severity-badge"
                  style={{ background: getSeverityColor(selectedExploit.severity) }}
                >
                  {selectedExploit.severity?.toUpperCase()}
                </span>
              </div>
              <div className="field">
                <label>Type:</label>
                <span>{selectedExploit.exploit_type}</span>
              </div>
              <div className="field">
                <label>Description:</label>
                <p>{selectedExploit.description}</p>
              </div>
              <div className="field">
                <label>Full Jailbreak Prompt:</label>
                <pre className="exploit-code">{selectedExploit.exploit_content}</pre>
                <p style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.5rem' }}>
                  This is the complete prompt that can be used to test this exploit against target models.
                </p>
              </div>
              {selectedExploit.target_models && selectedExploit.target_models.length > 0 && (
                <div className="field">
                  <label>Vulnerable Models:</label>
                  <div className="tags">
                    {selectedExploit.target_models.map((model, idx) => (
                      <span key={idx} className="tag">{model}</span>
                    ))}
                  </div>
                </div>
              )}
              {selectedExploit.mitigation && (
                <div className="field">
                  <label>Mitigation:</label>
                  <p>{selectedExploit.mitigation}</p>
                </div>
              )}
              <div className="field">
                <label>Date Discovered:</label>
                <span>{formatDiscoveredDate(selectedExploit.discovered_date)}</span>
              </div>
              <div className="field">
                <label>Source:</label>
                <span>
                  {selectedExploit.source || 'Unknown source'}
                  {selectedExploit.source_type ? ` (${selectedExploit.source_type})` : ''}
                </span>
              </div>
              <div className="modal-actions">
                <button
                  className="btn-delete"
                  onClick={() => deleteExploit(selectedExploit.id)}
                >
                  DELETE EXPLOIT
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
