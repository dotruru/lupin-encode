"""
Script to fix remaining exploit formatting issues
Improved version with better title and description generation
"""

import sqlite3
import re

def is_generic_title(title: str) -> bool:
    """Check if title is too generic or technical"""
    generic_patterns = [
        r'^[A-Z_]+$',  # ALL_CAPS_SNAKE_CASE
        r'^\w+\(\)$',  # function_name()
        r'^-\s*You\s+(Are|are)',  # "- You Are"
        r'^Handle\s+\w+',  # "Handle actions"
        r'^\w+\s+from\s+',  # "ActionConfigs from"
        len(title.split()) == 1 and len(title) < 15,  # Single short word
    ]

    return any(
        (isinstance(p, str) and re.match(p, title)) or
        (isinstance(p, bool) and p)
        for p in generic_patterns
    )

def extract_model_from_description(desc: str) -> str:
    """Extract AI model name from description"""
    models = {
        'chatgpt': 'ChatGPT',
        'gpt': 'GPT',
        'claude': 'Claude',
        'gemini': 'Gemini',
        'qwen': 'Qwen',
        'llama': 'LLaMA',
        'deepseek': 'DeepSeek',
        'mistral': 'Mistral',
        'cline': 'Cline',
        'chatkit': 'ChatKit',
        'dia': 'Dia Browser',
    }

    desc_lower = desc.lower()
    for key, name in models.items():
        if key in desc_lower:
            return name

    return 'LLM'

def improve_title(title: str, description: str) -> str:
    """Improve generic or technical titles"""
    if not is_generic_title(title):
        return title

    # Extract meaningful context
    desc_lower = description.lower()
    model = extract_model_from_description(description)

    # Pattern matching for better titles
    if 'system prompt' in desc_lower and 'mcp' not in desc_lower:
        return f'{model} System Prompt Leak'
    elif 'model context protocol' in desc_lower or 'mcp' in desc_lower:
        return 'MCP Server Exploitation'
    elif 'browser' in desc_lower and 'dia' in desc_lower:
        return 'Dia Browser AI Prompt Leak'
    elif 'replace_in_file' in title or 'read_file' in title or 'write_file' in title:
        return f'{title.replace("_", " ").title()} Command Injection'
    elif 'git' in desc_lower or title.lower() == 'git commands':
        return 'Git Command Injection Attack'
    elif 'action' in title.lower() and 'config' in title.lower():
        return 'ActionConfig Injection Attack'
    elif title.lower() in ['language', 'tone', 'profile', 'settings']:
        return f'{model} {title} Override Attack'
    elif 'handle' in title.lower():
        return f'{model} Action Handler Exploit'

    # Clean up the title
    clean = title.replace('_', ' ').replace('-', ' ')
    if clean.isupper():
        clean = clean.title()

    return f'{model} {clean}' if model != 'LLM' else clean

def improve_description(title: str, description: str, exploit_type: str) -> str:
    """Improve generic descriptions"""
    # If description is already good, keep it
    if len(description) > 50 and 'technique' not in description.lower() and \
       not description.startswith('System prompt') and \
       not description.startswith('Prompt injection') and \
       not description.startswith('Jailbreak technique'):
        return description

    model = extract_model_from_description(description + " " + title)
    desc_lower = description.lower()
    title_lower = title.lower()

    # Create context-aware descriptions
    if 'system prompt' in desc_lower or exploit_type == 'system_prompt':
        if 'chatgpt' in desc_lower or 'gpt' in desc_lower:
            return 'Leaked system prompt from ChatGPT revealing internal instructions and safety guidelines.'
        elif 'claude' in desc_lower or 'cline' in desc_lower:
            return 'Leaked system prompt from Claude/Cline revealing internal configuration and tool usage patterns.'
        elif 'dia' in desc_lower:
            return 'Leaked system prompt from Dia Browser AI revealing identity and operational constraints.'
        elif 'chatkit' in desc_lower:
            return 'Leaked system prompt from ChatKit framework exposing internal action handlers and client-side logic.'
        else:
            return f'Leaked system prompt from {model} revealing internal instructions, constraints, and safety mechanisms.'

    elif 'mcp' in desc_lower or 'model context protocol' in desc_lower:
        return 'Exploit targeting Model Context Protocol (MCP) servers to extend AI capabilities beyond intended scope.'

    elif 'file' in title_lower or 'git' in title_lower or 'command' in title_lower:
        return f'Command injection exploit targeting {model} tool usage capabilities to execute unauthorized file or system operations.'

    elif 'action' in desc_lower or 'handler' in desc_lower:
        return f'Exploit targeting {model} action handling mechanisms to bypass safety restrictions through malformed action configurations.'

    elif 'leetspeak' in desc_lower or 'l33t' in desc_lower:
        return f'Encoding-based bypass using leetspeak obfuscation to evade {model} content filters and safety mechanisms.'

    elif 'unfiltered' in desc_lower:
        return f'Prompt injection targeting {model} to extract unfiltered or uncensored responses bypassing content policies.'

    elif 'godmode' in desc_lower:
        return f'Advanced jailbreak technique attempting to enable unrestricted "GODMODE" on {model}, disabling all safety controls.'

    else:
        return f'Jailbreak exploit targeting {model} using prompt manipulation techniques to bypass safety restrictions and content policies.'

def main():
    conn = sqlite3.connect('lupin.db')
    cursor = conn.cursor()

    # Get all exploits
    cursor.execute("SELECT id, cve_id, title, description, exploit_type, severity FROM exploits")
    exploits = cursor.fetchall()

    print(f"Processing {len(exploits)} exploits for improvements...\n")

    improved_count = 0
    for exploit_id, cve_id, title, description, exploit_type, severity in exploits:
        original_title = title
        original_desc = description

        # Improve title if needed
        new_title = improve_title(title, description)

        # Improve description
        new_description = improve_description(new_title, description, exploit_type)

        # Update if changed
        if new_title != title or new_description != description:
            cursor.execute("""
                UPDATE exploits
                SET title = ?, description = ?
                WHERE id = ?
            """, (new_title, new_description, exploit_id))

            improved_count += 1
            if improved_count <= 15:  # Show first 15 examples
                print(f"Improved {cve_id}:")
                print(f"  Title: {original_title}")
                print(f"     -> {new_title}")
                if original_desc != new_description and len(new_description) < 150:
                    print(f"  Desc:  {new_description}")
                print()

    conn.commit()
    print(f"âœ… Improved {improved_count} exploits\n")

    # Show sample of results
    cursor.execute("""
        SELECT cve_id, title, description, severity
        FROM exploits
        WHERE severity IN ('critical', 'high')
        ORDER BY RANDOM()
        LIMIT 5
    """)

    print("Sample of improved exploits:")
    for cve, title, desc, sev in cursor.fetchall():
        print(f"\n{cve} [{sev.upper()}]")
        print(f"  {title}")
        print(f"  {desc[:100]}...")

    conn.close()

if __name__ == "__main__":
    main()
