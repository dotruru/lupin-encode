"""
Migrate exploits from the exploits table to the prompts table
This ensures the Lupin agent has access to all 530+ jailbreaks
"""
import asyncio
import sqlite3
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy import select, func
from app.models import Prompt, Exploit

DATABASE_URL = "sqlite+aiosqlite:///./lupin.db"

async def migrate_exploits_to_prompts():
    """Migrate exploits to prompts table"""
    engine = create_async_engine(DATABASE_URL, echo=False)
    async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
    
    async with async_session() as db:
        # Get all exploits
        result = await db.execute(select(Exploit))
        exploits = result.scalars().all()
        
        print(f"Found {len(exploits)} exploits to migrate")
        
        # Check existing prompts count
        count_result = await db.execute(select(func.count(Prompt.id)))
        existing_count = count_result.scalar()
        print(f"Existing prompts: {existing_count}")
        
        # Migrate each exploit to a prompt
        added_count = 0
        skipped_count = 0
        
        for exploit in exploits:
            # Check if prompt with same content already exists
            check_query = select(Prompt).where(Prompt.content == exploit.exploit_content).limit(1)
            check_result = await db.execute(check_query)
            existing_prompt = check_result.scalar_one_or_none()
            
            if existing_prompt:
                skipped_count += 1
                continue
            
            # Determine category based on exploit type
            category = "jailbreak" if exploit.exploit_type == "jailbreak" else "system_prompt"
            
            # Determine subcategory from description or title
            subcategory = "general"
            if exploit.description:
                desc_lower = exploit.description.lower()
                if "role" in desc_lower or "character" in desc_lower:
                    subcategory = "role_play"
                elif "instruction" in desc_lower or "override" in desc_lower:
                    subcategory = "instruction_override"
                elif "system" in desc_lower:
                    subcategory = "system_impersonation"
                elif "hypothetical" in desc_lower or "scenario" in desc_lower:
                    subcategory = "hypothetical"
                elif "creative" in desc_lower or "story" in desc_lower:
                    subcategory = "creative_framing"
            
            # Extract provider from target_models (first model mentioned)
            provider = "general"
            if exploit.target_models:
                models_str = exploit.target_models if isinstance(exploit.target_models, str) else str(exploit.target_models)
                models_lower = models_str.lower()
                if "claude" in models_lower or "anthropic" in models_lower:
                    provider = "anthropic"
                elif "gpt" in models_lower or "openai" in models_lower or "chatgpt" in models_lower:
                    provider = "openai"
                elif "gemini" in models_lower or "google" in models_lower:
                    provider = "google"
                elif "grok" in models_lower or "xai" in models_lower:
                    provider = "xai"
                elif "deepseek" in models_lower:
                    provider = "deepseek"
                elif "llama" in models_lower or "meta" in models_lower:
                    provider = "meta"
            
            # Create new prompt
            prompt = Prompt(
                content=exploit.exploit_content,
                source=exploit.source,
                category=category,
                subcategory=subcategory,
                provider=provider,
                severity=exploit.severity,
                extra_data={
                    "original_id": exploit.id,
                    "cve_id": exploit.cve_id,
                    "title": exploit.title,
                    "description": exploit.description,
                    "target_models": exploit.target_models,
                    "discovered_date": str(exploit.discovered_date) if exploit.discovered_date else None
                }
            )
            
            db.add(prompt)
            added_count += 1
            
            # Commit in batches of 50
            if added_count % 50 == 0:
                await db.commit()
                print(f"  Migrated {added_count} prompts...")
        
        # Final commit
        await db.commit()
        
        print(f"\nâœ… Migration complete!")
        print(f"  Added: {added_count}")
        print(f"  Skipped (duplicates): {skipped_count}")
        print(f"  Total prompts: {existing_count + added_count}")
        
        # Verify final count
        final_count_result = await db.execute(select(func.count(Prompt.id)))
        final_count = final_count_result.scalar()
        print(f"  Final verification: {final_count} prompts in database")

if __name__ == "__main__":
    asyncio.run(migrate_exploits_to_prompts())
